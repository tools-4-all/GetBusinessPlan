<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SeedWise - Dashboard utente con i tuoi documenti generati">
    <title>Dashboard - SeedWise</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABZKDDf1biPDKObo37zpaPOwd6TqLzoqw",
            authDomain: "seedwise-d0457.firebaseapp.com",
            projectId: "seedwise-d0457",
            storageBucket: "seedwise-d0457.firebasestorage.app",
            messagingSenderId: "761293808147",
            appId: "1:761293808147:web:18ea8bd8a89ac8d529d5e6",
            measurementId: "G-PFQ3ZGX3RM"
        };
        
        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Esponi auth, firestore e funzioni globalmente
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseAuthFunctions = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        };
        
        console.log('‚úÖ Firebase inizializzato (Auth + Firestore)');
    </script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .dashboard-header {
            margin-bottom: 40px;
        }
        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        .dashboard-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 28px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .documents-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        .document-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            transition: all 0.3s ease;
            cursor: default;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .document-card:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
            transform: translateY(-4px);
        }
        .document-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .document-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: var(--accent-light);
            color: var(--accent);
            flex-shrink: 0;
        }
        .document-icon.business-plan {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }
        .document-icon.market-analysis {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #d97706;
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.2);
        }
        .document-icon.validate-idea {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }
        .document-icon svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            fill: none;
        }
        .document-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        .document-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }
        .document-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 12px;
            margin-top: 40px;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .empty-state h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        /* Modal per visualizzare i documenti */
        .document-view-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        .document-view-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }
        .document-view-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .document-view-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }
        .document-view-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .document-view-modal-close:hover {
            background: var(--border);
            color: var(--text-primary);
        }
        .document-view-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            line-height: 1.8;
            color: #1e293b;
        }
        .document-view-modal-body h1 {
            color: #000000;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .document-view-modal-body h2 {
            color: #000000;
            font-size: 2rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .document-view-modal-body h3 {
            color: #000000;
            font-size: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo"><a href="index.html" style="text-decoration: none; color: inherit;">SeedWise</a></div>
                <nav class="nav">
                    <div id="authButtons" style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn-secondary" id="authBtn">Accedi</button>
                        <div id="userInfo" style="display: none; align-items: center; gap: 10px;">
                            <span id="userEmail" style="color: var(--text-secondary); font-size: 0.9em;"></span>
                        </div>
                    </div>
                    <button class="btn-primary" id="createPlanBtn">Inizia</button>
                    <a href="index.html" class="btn-link">Home</a>
                    <a href="dashboard.html" class="btn-link" id="dashboardLink" style="display: none; font-weight: 600;">Dashboard</a>
                    <!-- Menu a tendina -->
                    <div class="dropdown-menu">
                        <button class="dropdown-toggle" id="menuToggle" aria-label="Menu">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="19" cy="12" r="1"></circle>
                                <circle cx="5" cy="12" r="1"></circle>
                            </svg>
                        </button>
                        <div class="dropdown-content" id="menuDropdown">
                            <a href="blog.html" class="dropdown-item">Blog</a>
                            <button class="dropdown-item" id="logoutBtn" style="display: none;">Esci</button>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <section class="dashboard-container">
        <div class="dashboard-header">
            <h1>La tua Dashboard</h1>
            <p>Qui puoi vedere tutti i documenti che hai generato</p>
        </div>

        <div id="documentsList" class="documents-grid">
            <!-- I documenti verranno caricati qui -->
        </div>
    </section>

    <!-- Modal per visualizzare i documenti -->
    <div id="documentViewModal" class="document-view-modal">
        <div class="document-view-modal-content">
            <div class="document-view-modal-header">
                <h2 id="documentViewModalTitle">Documento</h2>
                <button class="document-view-modal-close" id="documentViewModalClose">&times;</button>
            </div>
            <div class="document-view-modal-body" id="documentViewModalBody">
                <!-- Il contenuto del documento verr√† inserito qui -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Usa currentUser, authInitialized e API_BASE_URL globali da script.js invece di dichiararne di nuovi
        // let currentUser = null; // RIMOSSO - usa quello globale da script.js
        // let authInitialized = false; // RIMOSSO - usa quello globale da script.js
        // const API_BASE_URL = ...; // RIMOSSO - usa window.API_BASE_URL da script.js

        // Funzioni Firebase Auth
        function getAuthFunctions() {
            return window.firebaseAuthFunctions || null;
        }

        // Inizializza autenticazione
        function initializeAuth() {
            const authFunctions = getAuthFunctions();
            if (!window.firebaseAuth || !authFunctions) {
                setTimeout(initializeAuth, 500);
                return;
            }

            const { onAuthStateChanged } = authFunctions;
            onAuthStateChanged(window.firebaseAuth, (user) => {
                // Usa currentUser globale da script.js
                if (typeof window !== 'undefined' && window.currentUser !== undefined) {
                    window.currentUser = user;
                } else {
                    // Se non esiste, crealo
                    window.currentUser = user;
                }
                const currentUser = window.currentUser; // Riferimento locale per questo scope
                authInitialized = true;
                updateAuthUI();
                if (user) {
                    loadDocuments();
                } else {
                    showLoginRequired();
                }
            });
        }

        // Aggiorna UI autenticazione
        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            const userInfo = document.getElementById('userInfo');
            const userEmail = document.getElementById('userEmail');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (currentUser) {
                if (authBtn) authBtn.style.display = 'none';
                if (userInfo) userInfo.style.display = 'flex';
                // Nella dashboard l'email √® sempre visibile
                if (userEmail) {
                    userEmail.textContent = currentUser.email || 'Utente';
                    userEmail.style.display = 'block';
                }
                
                // Mostra il pulsante "Esci" nel menu dropdown
                if (logoutBtn) {
                    logoutBtn.style.display = 'block';
                    logoutBtn.onclick = async () => {
                        try {
                            const authFunctions = getAuthFunctions();
                            if (authFunctions && window.firebaseAuth) {
                                const { signOut } = authFunctions;
                                await signOut(window.firebaseAuth);
                                window.currentUser = null;
                                updateAuthUI();
                                showLoginRequired();
                            }
                        } catch (error) {
                            console.error('Errore logout:', error);
                        }
                    };
                }
            } else {
                if (authBtn) {
                    authBtn.style.display = 'block';
                    authBtn.onclick = () => {
                        window.location.href = 'index.html';
                    };
                }
                if (userInfo) userInfo.style.display = 'none';
                
                // Nascondi il pulsante "Esci" nel menu dropdown
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
        }

        // Mostra messaggio login richiesto
        function showLoginRequired() {
            const documentsList = document.getElementById('documentsList');
            documentsList.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-state-icon">üîê</div>
                    <h2>Accesso richiesto</h2>
                    <p>Devi effettuare l'accesso per vedere i tuoi documenti</p>
                    <a href="index.html" class="btn-primary">Vai alla home</a>
                </div>
            `;
        }

        // Carica documenti da Firebase Firestore
        async function loadDocuments() {
            // Usa currentUser globale da script.js
            const currentUser = window.currentUser || null;
            
            if (!currentUser || !currentUser.uid) {
                showLoginRequired();
                return;
            }

            const documentsList = document.getElementById('documentsList');
            documentsList.innerHTML = '<div style="text-align: center; padding: 40px;">Caricamento documenti...</div>';

            try {
                const userId = currentUser.uid;
                let documents = [];
                
                // Prova a caricare da Firestore
                console.log('üîç Verifica Firestore disponibile:', !!window.firebaseDb);
                if (window.firebaseDb) {
                    try {
                        console.log('üì° Caricamento documenti da Firestore...');
                        const { collection, getDocs, query, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        console.log('‚úÖ Moduli Firestore importati');
                        
                        const documentsRef = collection(window.firebaseDb, 'users', userId, 'documents');
                        console.log('üìç Percorso Firestore: users/' + userId + '/documents');
                        
                        const q = query(documentsRef, orderBy('createdAt', 'desc'), limit(50));
                        console.log('üîÑ Esecuzione query Firestore...');
                        const querySnapshot = await getDocs(q);
                        console.log('‚úÖ Query completata, documenti trovati:', querySnapshot.docs.length);
                        
                        documents = querySnapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: data.id || doc.id,
                                type: data.type,
                                title: data.title,
                                date: data.date || data.createdAt,
                                html: data.html,
                                json: data.json ? JSON.parse(data.json) : null,
                                wizardData: data.wizardData ? JSON.parse(data.wizardData) : null
                            };
                        });
                        
                        console.log('‚úÖ Documenti caricati da Firestore:', documents.length);
                        if (documents.length > 0) {
                            console.log('Primo documento:', documents[0].title, documents[0].type);
                        }
                    } catch (firestoreError) {
                        console.error('‚ùå Errore nel caricamento da Firestore:', firestoreError);
                        console.error('Tipo errore:', firestoreError.constructor.name);
                        console.error('Codice errore:', firestoreError.code);
                        console.error('Messaggio:', firestoreError.message);
                        
                        // Se √® un errore di permesso, mostra un messaggio pi√π chiaro
                        if (firestoreError.code === 'permission-denied' || firestoreError.message.includes('permission')) {
                            console.error('‚ùå ERRORE PERMESSI FIRESTORE: Le regole di sicurezza di Firestore potrebbero bloccare la lettura');
                            alert('Errore: permessi Firestore insufficienti. Verifica le regole di sicurezza su Firebase Console.');
                        }
                        
                        // Fallback a localStorage
                        console.log('üîÑ Fallback a localStorage...');
                        const storageKey = `user_documents_${userId}`;
                        const existingData = localStorage.getItem(storageKey);
                        if (existingData) {
                            documents = JSON.parse(existingData);
                            documents.sort((a, b) => new Date(b.date) - new Date(a.date));
                            console.log('‚úÖ Documenti caricati da localStorage (fallback):', documents.length);
                        }
                    }
                } else {
                    // Fallback a localStorage se Firestore non √® disponibile
                    console.log('‚ö†Ô∏è Firestore non disponibile, uso localStorage');
                    const storageKey = `user_documents_${userId}`;
                    const existingData = localStorage.getItem(storageKey);
                    if (existingData) {
                        documents = JSON.parse(existingData);
                        documents.sort((a, b) => new Date(b.date) - new Date(a.date));
                        console.log('‚úÖ Documenti caricati da localStorage:', documents.length);
                    } else {
                        console.log('‚ÑπÔ∏è Nessun documento trovato in localStorage');
                    }
                }
                
                if (documents.length === 0) {
                    documentsList.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <div class="empty-state-icon">üìÑ</div>
                            <h2>Nessun documento ancora</h2>
                            <p>I documenti che generi appariranno qui</p>
                            <a href="index.html" class="btn-primary">Crea il tuo primo documento</a>
                        </div>
                    `;
                } else {
                    documentsList.innerHTML = documents.map(doc => {
                        const date = new Date(doc.date);
                        const dateStr = date.toLocaleDateString('it-IT', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        let typeLabel, iconClass, iconSvg;
                        if (doc.type === 'business-plan') {
                            typeLabel = 'Business Plan';
                            iconClass = 'business-plan';
                            iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>`;
                        } else if (doc.type === 'market-analysis') {
                            typeLabel = 'Analisi di Mercato';
                            iconClass = 'market-analysis';
                            iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>`;
                        } else if (doc.type === 'validate-idea') {
                            typeLabel = 'Validazione Idea';
                            iconClass = 'validate-idea';
                            iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>`;
                        } else {
                            typeLabel = 'Documento';
                            iconClass = 'document';
                            iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>`;
                        }
                        
                        return `
                            <div class="document-card" data-doc-id="${doc.id}">
                                <div class="document-card-header">
                                    <div class="document-icon ${iconClass}">${iconSvg}</div>
                                    <div>
                                        <h3 class="document-title">${escapeHtml(doc.title)}</h3>
                                        <div class="document-meta">
                                            <div style="font-weight: 500; margin-bottom: 4px;">${typeLabel}</div>
                                            <div style="font-size: 0.85rem; opacity: 0.8;">${dateStr}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="document-actions">
                                    <button class="btn-primary btn-small" onclick="viewDocument('${doc.id}')" style="flex: 1;">Visualizza</button>
                                    <button class="btn-secondary btn-small" onclick="downloadDocument('${doc.id}')" style="flex: 1;">Scarica PDF</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Errore nel caricamento documenti:', error);
                document.getElementById('documentsList').innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h2>Errore nel caricamento</h2>
                        <p>Si √® verificato un errore nel caricamento dei documenti</p>
                    </div>
                `;
            }
        }

        // Visualizza documento
        async function viewDocument(docId) {
            // Usa currentUser globale da script.js
            const currentUser = window.currentUser || null;
            
            if (!currentUser || !currentUser.uid) return;
            
            const userId = currentUser.uid;
            let doc = null;
            
            // Prova a caricare da Firestore
            if (window.firebaseDb) {
                try {
                    const { doc: docRef, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const docSnap = await getDoc(docRef(window.firebaseDb, 'users', userId, 'documents', docId));
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        doc = {
                            id: data.id || docSnap.id,
                            type: data.type,
                            title: data.title,
                            date: data.date || data.createdAt,
                            html: data.html,
                            json: data.json ? JSON.parse(data.json) : null,
                            wizardData: data.wizardData ? JSON.parse(data.wizardData) : null
                        };
                    }
                } catch (firestoreError) {
                    console.error('‚ùå Errore nel caricamento documento da Firestore:', firestoreError);
                }
            }
            
            // Fallback a localStorage
            if (!doc) {
                const storageKey = `user_documents_${userId}`;
                const existingData = localStorage.getItem(storageKey);
                if (existingData) {
                    const documents = JSON.parse(existingData);
                    doc = documents.find(d => d.id === docId);
                }
            }
            
            if (doc) {
                // Salva il documento temporaneamente per la visualizzazione
                window.currentViewingDocument = doc;
                
                // Prova ad aprire in una nuova finestra
                const newWindow = window.open('', '_blank');
                
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    // Se il popup √® stato bloccato, mostra il documento in un modal
                    console.log('‚ö†Ô∏è Popup bloccato, apro il documento in un modal');
                    showDocumentModal(doc);
                } else {
                    // Popup aperto con successo
                    try {
                        newWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <title>${escapeHtml(doc.title)}</title>
                                <style>
                                    body { 
                                        font-family: 'Inter', Arial, sans-serif; 
                                        max-width: 800px; 
                                        margin: 0 auto; 
                                        padding: 40px 20px; 
                                        line-height: 1.8;
                                        color: #1e293b;
                                    }
                                    h1 { color: #000000; font-size: 2.5rem; margin-bottom: 0.5rem; }
                                    h2 { color: #000000; font-size: 2rem; margin-top: 2rem; margin-bottom: 1rem; }
                                    h3 { color: #000000; font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.75rem; }
                                </style>
                            </head>
                            <body>
                                ${doc.html}
                            </body>
                            </html>
                        `);
                        newWindow.document.close();
                    } catch (error) {
                        console.error('Errore nella scrittura del documento:', error);
                        // Fallback al modal
                        newWindow.close();
                        showDocumentModal(doc);
                    }
                }
            } else {
                alert('Documento non trovato');
            }
        }

        // Scarica documento come PDF tramite backend
        async function downloadDocument(docId) {
            // Usa currentUser globale da script.js
            const currentUser = window.currentUser || null;
            
            if (!currentUser || !currentUser.uid) {
                alert('Devi essere autenticato per scaricare il PDF');
                return;
            }
            
            const userId = currentUser.uid;
            let doc = null;
            
            console.log('üì• Caricamento documento per generazione PDF...');
            
            // Prova a caricare da Firestore
            if (window.firebaseDb) {
                try {
                    const { doc: docRef, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const docSnap = await getDoc(docRef(window.firebaseDb, 'users', userId, 'documents', docId));
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        doc = {
                            id: data.id || docSnap.id,
                            type: data.type,
                            title: data.title,
                            date: data.date || data.createdAt,
                            html: data.html,
                            json: data.json ? JSON.parse(data.json) : null,
                            wizardData: data.wizardData ? JSON.parse(data.wizardData) : null
                        };
                    }
                } catch (firestoreError) {
                    console.error('‚ùå Errore nel caricamento documento da Firestore:', firestoreError);
                }
            }
            
            // Fallback a localStorage
            if (!doc) {
                const storageKey = `user_documents_${userId}`;
                const existingData = localStorage.getItem(storageKey);
                if (existingData) {
                    const documents = JSON.parse(existingData);
                    doc = documents.find(d => d.id === docId);
                }
            }
            
            if (!doc) {
                alert('Documento non trovato');
                return;
            }
            
            // Verifica che il documento abbia il JSON necessario per generare il PDF
            if (!doc.json) {
                alert('Errore: il documento non contiene i dati necessari per generare il PDF. Il documento potrebbe essere stato creato prima dell\'implementazione del salvataggio JSON.');
                return;
            }
            
            try {
                // Ottieni il token Firebase per l'autenticazione
                let idToken = null;
                try {
                    idToken = await currentUser.getIdToken(true);
                } catch (tokenError) {
                    console.error('Errore nell\'ottenere il token:', tokenError);
                    alert('Errore di autenticazione. Effettua nuovamente il login.');
                    return;
                }
                
                // Usa API_BASE_URL globale da script.js
                const apiBaseUrl = window.API_BASE_URL || 'https://getbusinessplan.onrender.com';
                let endpoint = '';
                let requestBody = {};
                
                // Determina l'endpoint in base al tipo di documento
                if (doc.type === 'business-plan') {
                    endpoint = `${apiBaseUrl}/api/generate-pdf`;
                    requestBody = {
                        businessPlanJson: doc.json
                    };
                } else if (doc.type === 'market-analysis') {
                    endpoint = `${apiBaseUrl}/api/generate-pdf-analysis`;
                    requestBody = {
                        marketAnalysisJson: doc.json
                    };
                } else if (doc.type === 'validate-idea') {
                    endpoint = `${apiBaseUrl}/api/generate-pdf-validation`;
                    requestBody = {
                        validationJson: doc.json
                    };
                } else {
                    alert('Tipo di documento non supportato');
                    return;
                }
                
                console.log('üîÑ Chiamata backend per generazione PDF...');
                console.log('Endpoint:', endpoint);
                console.log('Tipo documento:', doc.type);
                
                // Mostra un indicatore di caricamento
                const loadingMessage = document.createElement('div');
                loadingMessage.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10001;';
                loadingMessage.innerHTML = '<p>Generazione PDF in corso...</p>';
                document.body.appendChild(loadingMessage);
                
                // Chiama il backend
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // Rimuovi l'indicatore di caricamento
                document.body.removeChild(loadingMessage);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Errore sconosciuto' }));
                    throw new Error(errorData.detail || `Errore HTTP ${response.status}`);
                }
                
                // Scarica il PDF
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${doc.title.replace(/[^a-z0-9]/gi, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ PDF scaricato con successo');
                
            } catch (error) {
                console.error('‚ùå Errore nella generazione PDF:', error);
                alert('Errore nella generazione del PDF: ' + error.message);
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Mostra documento in un modal
        function showDocumentModal(doc) {
            const modal = document.getElementById('documentViewModal');
            const modalTitle = document.getElementById('documentViewModalTitle');
            const modalBody = document.getElementById('documentViewModalBody');
            const modalClose = document.getElementById('documentViewModalClose');
            
            if (!modal || !modalTitle || !modalBody) {
                console.error('Modal elementi non trovati');
                return;
            }
            
            modalTitle.textContent = escapeHtml(doc.title);
            modalBody.innerHTML = doc.html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Chiudi modal quando si clicca sulla X
            if (modalClose) {
                modalClose.onclick = () => {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                };
            }
            
            // Chiudi modal quando si clicca fuori
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            };
            
            // Chiudi modal con ESC
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }

        // Il menu dropdown viene gestito da script.js - non serve una funzione locale

        // Esponi le funzioni necessarie come globali per renderle disponibili
        window.openServicesModal = function() {
            const servicesModal = document.getElementById('servicesModal');
            if (servicesModal) {
                servicesModal.style.display = 'block';
            }
        };
        
        window.closeServicesModal = function() {
            const servicesModal = document.getElementById('servicesModal');
            if (servicesModal) {
                servicesModal.style.display = 'none';
            }
        };

        // Inizializza quando il DOM √® pronto
        // Le funzioni di script.js verranno chiamate automaticamente
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeAuth();
                // Aspetta che script.js sia completamente caricato
                setTimeout(() => {
                    // Le funzioni di script.js dovrebbero essere gi√† disponibili
                    console.log('Dashboard initialized');
                }, 100);
            });
        } else {
            initializeAuth();
            // Aspetta che script.js sia completamente caricato
            setTimeout(() => {
                console.log('Dashboard initialized');
            }, 100);
        }
    </script>
    
    <!-- Modal for Services Selection -->
    <div class="modal" id="servicesModal" style="display: none;">
        <div class="modal-content services-modal-content">
            <span class="close" id="closeServicesModal">&times;</span>
            <div class="services-modal-header">
                <h2>I Nostri Servizi</h2>
                <p class="services-modal-subtitle">Scegli il servizio che fa per te</p>
            </div>
            <div class="services-grid">
                <button class="service-card" id="serviceBusinessPlan">
                    <div class="service-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <div class="service-content">
                        <h3>Business Plan</h3>
                        <p>Crea un business plan professionale completo in 15 minuti con l'AI</p>
                    </div>
                    <div class="service-arrow">‚Üí</div>
                </button>
                <button class="service-card" id="serviceMarketAnalysis">
                    <div class="service-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>
                    <div class="service-content">
                        <h3>Analisi di Mercato</h3>
                        <p>Analisi approfondita del mercato italiano con competitor e tendenze</p>
                    </div>
                    <div class="service-arrow">‚Üí</div>
                </button>
                <button class="service-card" id="serviceValidateIdea">
                    <div class="service-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <div class="service-content">
                        <h3>Valida la tua idea</h3>
                        <p>Ottieni un report completo di validazione per la tua idea di business</p>
                    </div>
                    <div class="service-arrow">‚Üí</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Authentication -->
    <div class="modal" id="authModal" style="display: none;">
        <div class="modal-content" style="max-width: 480px;">
            <span class="close" id="closeAuthModal">&times;</span>
            <div style="text-align: center; margin-bottom: 24px;">
                <h2 style="margin-bottom: 8px; font-size: 1.75em;">Accedi al tuo account</h2>
                <p style="color: #64748b; font-size: 0.95em;">Per procedere con il pagamento, √® necessario accedere o creare un account.</p>
            </div>
            
            <!-- Unified Auth Form -->
            <form id="authForm" onsubmit="return false;">
                <div style="margin-bottom: 18px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                    <input 
                        type="email" 
                        id="authEmail" 
                        placeholder="nome@esempio.com" 
                        required 
                        autocomplete="email"
                        style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; transition: all 0.2s ease;"
                        onfocus="this.style.borderColor='var(--accent)'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)';"
                        onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';"
                    >
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Password</label>
                    <input 
                        type="password" 
                        id="authPassword" 
                        placeholder="Inserisci la tua password" 
                        required 
                        minlength="6"
                        autocomplete="current-password"
                        style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; transition: all 0.2s ease;"
                        onfocus="this.style.borderColor='var(--accent)'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)';"
                        onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';"
                    >
                    <div id="passwordHint" style="display: none; margin-top: 6px; font-size: 0.85em; color: #64748b;">
                        <span id="passwordHintText"></span>
                    </div>
                </div>
                
                <!-- Confirm Password (solo per registrazione) -->
                <div id="confirmPasswordContainer" style="margin-bottom: 20px; display: none;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Conferma Password</label>
                    <input 
                        type="password" 
                        id="authPasswordConfirm" 
                        placeholder="Ripeti la password" 
                        minlength="6"
                        autocomplete="new-password"
                        style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; transition: all 0.2s ease;"
                        onfocus="this.style.borderColor='var(--accent)'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)';"
                        onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';"
                    >
                </div>
                
                <!-- Error Message -->
                <div id="authError" style="display: none; color: #dc2626; padding: 12px; background: #fee2e2; border-radius: 8px; margin-bottom: 16px; font-size: 0.9em; line-height: 1.5;"></div>
                
                <!-- Success/Info Message -->
                <div id="authInfo" style="display: none; color: #059669; padding: 12px; background: #d1fae5; border-radius: 8px; margin-bottom: 16px; font-size: 0.9em; line-height: 1.5;"></div>
                
                <!-- Submit Button -->
                <button 
                    type="submit" 
                    class="btn-primary" 
                    id="submitAuth" 
                    style="width: 100%; padding: 14px; font-size: 1em; font-weight: 600; margin-bottom: 16px;"
                >
                    Accedi
                </button>
                
                <!-- Switch Mode Link -->
                <div id="switchModeContainer" style="text-align: center; padding-top: 16px; border-top: 1px solid var(--border);">
                    <p style="color: #64748b; font-size: 0.9em; margin-bottom: 8px;" id="switchModeText">
                        Non hai un account?
                    </p>
                    <button 
                        type="button" 
                        id="switchModeBtn" 
                        style="background: none; border: none; color: var(--accent); cursor: pointer; font-weight: 600; font-size: 0.95em; text-decoration: underline;"
                    >
                        Crea un account
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Payment -->
    <div class="modal" id="paymentModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" id="closePaymentModal">&times;</span>
            <h2>Completa il Pagamento</h2>
            <div id="paymentContent">
                <p>Per scaricare il PDF professionale, completa il pagamento.</p>
                <div id="paymentLoading" style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p>Preparazione pagamento...</p>
                </div>
                <div id="paymentError" style="display: none; color: #dc2626; padding: 10px; background: #fee2e2; border-radius: 6px; margin: 10px 0;"></div>
            </div>
        </div>
    </div>
</body>
</html>
